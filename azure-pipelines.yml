trigger:
- main

pool:
  vmImage: 'ubuntu-latest'

variables:
  GITHUB_USERNAME: mateusmanhani   # your GitHub username

steps:
- checkout: self
  persistCredentials: true

- bash: |
    set -euo pipefail
    echo "Remotes:"; git remote -v
    echo "Before push: ref=$(git rev-parse --abbrev-ref HEAD) sha=$(git rev-parse --short HEAD)"

    # Ensure the 'github' remote points to the correct repo
    git remote remove github 2>/dev/null || true
    git remote add github "https://${GITHUB_USERNAME}:${GITHUB_PAT}@github.com/mateusmanhani/AppointmentBookingSystem.git"

    # Fetch remote heads for visibility and lease safety
    git fetch github +refs/heads/*:refs/remotes/github/* || true

    # Overwrite GitHub main with the current commit from this pipeline
    git push --force-with-lease github HEAD:refs/heads/main

    # Optional: mirror tags as well; force to overwrite tag refs if needed
    git push --force --tags github || true

    echo "After push, remote heads:"
    git ls-remote --heads github
  displayName: 'Push code to GitHub (mirror main)'
  env:
    GITHUB_USERNAME: $(GITHUB_USERNAME)
    GITHUB_PAT: $(githubPat)   # define this as a secret variable in the pipeline UI
